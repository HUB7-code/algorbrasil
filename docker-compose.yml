version: '3.8'

services:
  # Serviço da API (Python/FastAPI)
  backend:
    build: .
    container_name: algor_backend
    restart: always
    volumes:
      # Persistir Banco de Dados SQLite (Caminho correto na raiz)
      - ./backend/sql_app.db:/app/sql_app.db
      # Persistir Uploads (LMS)
      - ./backend/app/static/uploads:/app/backend/app/static/uploads
      # Montar Assets Públicos (Logo para Emails) - CRÍTICO PARA VPS
    environment:
      # - DATABASE_URL=sqlite:///./sql_app.db # Legacy SQLite
      - DATABASE_URL=sqlite:///./sql_app.db
      - SECRET_KEY=${SECRET_KEY}
      - DATA_ENCRYPTION_KEY=${DATA_ENCRYPTION_KEY}
      - SMTP_SERVER=${SMTP_SERVER}
      - SMTP_PORT=${SMTP_PORT}
      - SMTP_USER=${SMTP_USER}
      - SMTP_PASSWORD=${SMTP_PASSWORD}
      - SMTP_FROM_EMAIL=${SMTP_FROM_EMAIL}
      - FRONTEND_URL=${FRONTEND_URL}
      # depends_on removed since we are using SQLite for MVP stability

      # Serviço Frontend (Next.js)
  frontend:
    image: node:20-alpine
    container_name: algor_frontend
    working_dir: /app
    volumes:
      - ./frontend:/app
      - /app/node_modules
    ports:
      - "3000:3000"
    # Build para produção (Mais performático e estável)
    environment:
      - NEXT_PUBLIC_API_URL=${FRONTEND_URL}/api/v1
    command: sh -c "npm install && npm run build && npm start"

  # Serviço Web (Nginx)
  web:
    image: nginx:alpine
    container_name: algor_web
    restart: always
    ports:
      - "80:80"
      - "443:443"
    volumes:
      # Montar APENAS a configuração do Nginx (não todo o projeto!)
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      # Volumes para Certbot (SSL)
      - ./certbot/conf:/etc/letsencrypt:ro
      - ./certbot/www:/var/www/certbot:ro
    depends_on:
      - backend
      - frontend

  # Serviço Certbot (Gera os certificados SSL)
  certbot:
    image: certbot/certbot
    volumes:
      - ./certbot/conf:/etc/letsencrypt
      - ./certbot/www:/var/www/certbot

  # Gestão de Banco de Dados (Adminer)
  # Acessível via /db-admin (configurado no Nginx)
  adminer:
    image: adminer
    container_name: algor_adminer
    restart: always
    environment:
      - ADMINER_DEFAULT_SERVER=sqlite
    volumes:
      - ./backend/sql_app.db:/app/sql_app.db # Acessa o mesmo arquivo DB
    # Nota: Adminer roda na porta 8080 por padrão do container

    # Rede compartilhada
volumes:
  postgres_data:


networks:
  default:
    name: algor_network
