version: '3.8'

services:
  # Serviço da API (Python/FastAPI)
  backend:
    build: .
    container_name: algor_backend
    restart: always
    volumes:
      # Persistir Banco de Dados SQLite (Caminho correto na raiz)
      - ./backend/sql_app.db:/app/sql_app.db
    environment:
      - DATABASE_URL=sqlite:///./sql_app.db
      - SMTP_SERVER=smtp-relay.brevo.com
      - SMTP_PORT=587
      - SMTP_USER=edisio.nascimentojr@gmail.com
      - SMTP_PASSWORD=${SMTP_PASSWORD}
      - SMTP_FROM_EMAIL=contato@algorbrasil.com.br
    # Não expomos a porta 8000 para fora, apenas para a rede interna do Docker (o Nginx acessa)

    # Serviço Web (Nginx)
  web:
    image: nginx:alpine
    container_name: algor_web
    restart: always
    ports:
      - "80:80"
      - "443:443"
    volumes:
      # Montar os arquivos estáticos (HTML/JS/CSS/Images)
      - .:/usr/share/nginx/html
      # Montar a configuração do Nginx
      - ./nginx.conf:/etc/nginx/nginx.conf
      # Volumes para Certbot (SSL)
      - ./certbot/conf:/etc/letsencrypt
      - ./certbot/www:/var/www/certbot
    depends_on:
      - backend

  # Serviço Certbot (Gera os certificados SSL)
  certbot:
    image: certbot/certbot
    volumes:
      - ./certbot/conf:/etc/letsencrypt
      - ./certbot/www:/var/www/certbot

  # Gestão de Banco de Dados (Adminer)
  # Acessível via /db-admin (configurado no Nginx)
  adminer:
    image: adminer
    container_name: algor_adminer
    restart: always
    environment:
      - ADMINER_DEFAULT_SERVER=sqlite
    volumes:
      - ./backend/sql_app.db:/app/sql_app.db # Acessa o mesmo arquivo DB
    # Nota: Adminer roda na porta 8080 por padrão do container

    # Rede compartilhada (opcional, pois docker-compose cria default)
networks:
  default:
    name: algor_network
