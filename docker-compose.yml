version: '3.8'

services:
  # Serviço da API (Python/FastAPI)
  backend:
    build: .
    container_name: algor_backend
    restart: always
    volumes:
      # Persistir Banco de Dados SQLite (Caminho correto na raiz)
      - ./backend/sql_app.db:/app/sql_app.db
      # Persistir Uploads (LMS)
      - ./backend/app/static/uploads:/app/backend/app/static/uploads
      # Montar Assets Públicos (Logo para Emails) - CRÍTICO PARA VPS
    environment:
      # - DATABASE_URL=sqlite:///./sql_app.db # Legacy SQLite
      - DATABASE_URL=postgresql://algor:algor_secure_pass@db:5432/algor_db
      - SECRET_KEY=${SECRET_KEY}
      - DATA_ENCRYPTION_KEY=${DATA_ENCRYPTION_KEY}
      - SMTP_SERVER=${SMTP_SERVER}
      - SMTP_PORT=${SMTP_PORT}
      - SMTP_USER=${SMTP_USER}
      - SMTP_PASSWORD=${SMTP_PASSWORD}
      - SMTP_FROM_EMAIL=${SMTP_FROM_EMAIL}
      - FRONTEND_URL=${FRONTEND_URL}
    depends_on:
      - db

  # Serviço Banco de Dados (PostgreSQL 16)
  db:
    image: postgres:16-alpine
    container_name: algor_db
    restart: always
    environment:
      - POSTGRES_USER=algor
      - POSTGRES_PASSWORD=algor_secure_pass
      - POSTGRES_DB=algor_db
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data

  # Serviço Frontend (Next.js)
  frontend:
    image: node:20-alpine
    container_name: algor_frontend
    working_dir: /app
    volumes:
      - ./frontend:/app
    ports:
      - "3000:3000"
    # Instala dependências e roda o servidor de desenvolvimento
    command: sh -c "npm install && npm run dev"

  # Serviço Web (Nginx)
  web:
    image: nginx:alpine
    container_name: algor_web
    restart: always
    ports:
      - "80:80"
      - "443:443"
    volumes:
      # Montar os arquivos estáticos (HTML/JS/CSS/Images)
      - .:/usr/share/nginx/html
      # Montar a configuração do Nginx
      - ./nginx.conf:/etc/nginx/nginx.conf
      # Volumes para Certbot (SSL)
      - ./certbot/conf:/etc/letsencrypt
      - ./certbot/www:/var/www/certbot
    depends_on:
      - backend

  # Serviço Certbot (Gera os certificados SSL)
  certbot:
    image: certbot/certbot
    volumes:
      - ./certbot/conf:/etc/letsencrypt
      - ./certbot/www:/var/www/certbot

  # Gestão de Banco de Dados (Adminer)
  # Acessível via /db-admin (configurado no Nginx)
  adminer:
    image: adminer
    container_name: algor_adminer
    restart: always
    environment:
      - ADMINER_DEFAULT_SERVER=sqlite
    volumes:
      - ./backend/sql_app.db:/app/sql_app.db # Acessa o mesmo arquivo DB
    # Nota: Adminer roda na porta 8080 por padrão do container

    # Rede compartilhada
volumes:
  postgres_data:


networks:
  default:
    name: algor_network
